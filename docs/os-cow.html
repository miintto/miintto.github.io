<!DOCTYPE html>

<html>





<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Copy-on-Write 이란? - miintto.log</title>

  <meta name="description" content="지난번 인스타그램이 서버를 최적화한 여러 포스트를 작성하면서 ‘Copy on Write’ 라는 키워드를 많이 접하게 되었습니다. 관련해서 찾아보았던 내용 아래에 정리해 보았습니다.">

  <meta name="google-site-verification" content="wGN_mZVjgAC8sdItYCBTkSMwLrgNSWPY6sicU3MuSQw" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital@1&display=swap">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://miintto.github.io/docs/os-cow">
  <link rel="alternate" type="application/rss+xml" title="Copy-on-Write 이란? - miintto.log" href="/feed.xml">

  <link rel="apple-touch-icon" href="/img/favicon-128.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  <meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="blog"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="Copy-on-Write 이란? - miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="지난번 인스타그램이 서버를 최적화한 여러 포스트를 작성하면서 ‘Copy on Write’ 라는 키워드를 많이 접하게 되었습니다. 관련해서 찾아보았던 내용 아래에 정리해 보았습니다."/>
  <meta prefix="og: http://ogp.me/ns#" property="og:locale" content="ko_KR"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://miintto.github.io/docs/os-cow"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/img/thumbnails/os.png">

</head>


<body>

  <!-- Navigation -->

<nav class="navbar" style="background-color: white;">

  <div class="navbar-content container">
    <a class="navbar-brand" href="/">miintto.log</a>
    <button class="navbar-button" id="toggleButton" type="button" data-toggle="collapse" aria-controls="navbarResponsive" aria-expanded="false">
      MENU
      <i class="fa fa-bars"></i>
    </button>
    <div class="navbar-nav" id="navbarResponsive" aria-hidden="true">
      <div class="nav-item">
        <a class="nav-link" href="/about">ABOUT</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/posts">POSTS</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/archive">ARCHIVES</a>
      </div>
    </div>
  </div>
</nav>


  <div class="article">
  <div class="article-wrapper">
    <div class="article-header">
      <div class="article-info">
        <h1>Copy-on-Write 이란?</h1>
        <div class="post-tags">
          <p>virtual memory</p><p>copy-on-write</p>
        </div>
        <div class="article-meta">
          2024.04.21 &middot; <span class="reading-time" title="Estimated read time">
  
   4 mins  read </span>

        </div>
      </div>
      <div class="article-banner"">
        <img src="/img/thumbnails/os.png">
      </div>
    </div>

    <div class="article-content">
      <aside>
  <div class="section-toc">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#1-virtual-memory">1. Virtual Memory</a>
<ul>
<li class="toc-entry toc-h2"><a href="#11-page">1.1 Page</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#2-copy-on-write">2. Copy on Write</a></li>
</ul>
  </div>
</aside>


      <p>지난번 인스타그램이 서버를 최적화한 여러 포스트를 작성하면서 ‘Copy on Write’ 라는 키워드를 많이 접하게 되었습니다.
관련해서 찾아보았던 내용 아래에 정리해 보았습니다.</p>

<hr />

<h1 id="1-virtual-memory">1. Virtual Memory</h1>

<p>운영체제는 프로세스 실행 시에 고유한 메모리를 할당하게 되는데, 실제 컴퓨터의 물리 메모리가 아니라 추상화된 자원을 할당합니다.
이러한 추상화된 메모리 공간을 <strong>가상 메모리</strong>(Virtual Memory)라고 합니다.</p>

<p>가상 메모리는 컴퓨터의 메모리보다 큰 프로세스를 실행하기 위해 고안된 기술입니다.
여러 프로세스가 동시에 실행되는 멀티프로세싱 환경에서는 프로세스가 점유하는 메모리가 컴퓨터의 실제 물리 메모리를 초과하는 경우가 발생할 수 있는데, 이러한 상황에서 자원을 효율적으로 관리하기 위해 가상 메모리라는 개념이 도입되었습니다.</p>

<p>운영체제는 가상 메모리 주소(virtual address) 공간을 할당하고, 필요할 때마다 실제 물리 주소(physical address)에 매핑합니다.
이러한 작업은 운영체제에서 <strong>MMU</strong>(Memory Management Unit)라고 불리는 메모리 관리 유닛에 의해 처리됩니다.</p>

<p>이렇게 가상 메모리를 도입하면서 여러 이점이 있는데, 우선 응용 프로그램이 공유 메모리 공간을 직접 관리할 필요가 없어졌습니다.
또한 프로세스 간의 공유 메모리를 활용하여 공통으로 사용하는 라이브러리를 효율적으로 관리할 수 있습니다.
그리고 페이징이나 세그먼트 기술로 컴퓨터가 보유한 메모리보다 더 많은 메모리를 할당하여 프로그램을 실행할 수 있습니다.</p>

<h2 id="11-page">1.1 Page</h2>

<p>가상 메모리 구현체는 메모리 공간을 연속적인 가상 메모리 주소 블록으로 나누어 저장하는데, 이러한 블록을 <strong>페이지</strong>(Page)라고 합니다.
하나의 페이지는 최소 4KB의 크기를 가집니다.</p>

<p><img src="/img/posts/os-cow-page-table.png" style="max-width:540px" /></p>

<p><strong>페이지 테이블</strong>(Page Table)은 메모리의 가상 주소와 물리 주소를 연결하는 자료 구조입니다.
응용 프로그램은 가상 주소 공간에서 작동하지만 페이지 테이블에 따라 물리 주소로 변환되어 메모리에 접근하게 됩니다.
이러한 변환을 처리하는 하드웨어가 바로 위에서 설명한 MMU입니다.</p>

<p>각 페이지 테이블 엔트리에는 해당 페이지가 실제 물리 메모리에 있는지 여부를 추적하고 있습니다.
해당 페이지가 메모리에 존재하는 경우에는 물리 주소를 포함하고, 존재하지 않는 경우에는 디스크로 이동해야 함을 알리는 플래그를 포함하고 있습니다.</p>

<p>가상 메모리의 모든 데이터가 물리 메모리에 저장되는 것은 아닙니다.
메모리가 부족해짐에 따라 일부 데이터가 물리 메모리에서 디스크로 옮겨질 수 있습니다.
이때 물리 메모리에 존재하지 않는 페이지에 접근하는 경우 <strong>페이지 폴트</strong>(Page Fault)를 발생시키고 해당 페이지를 디스크에서 메모리로 옮겨오거나 다른 필요한 조치를 취하게 됩니다.</p>

<hr />

<h1 id="2-copy-on-write">2. Copy on Write</h1>

<p><strong>Copy on Write</strong>(COW)는 여러 프로세스가 물리적인 메모리 공간을 공유하는 경우에 이를 최적화 하기 위한 작업입니다.
메모리 페이지에 대해서 복제본이 필요한 경우에만 복사를 수행하여 공유 메모리를 효율적으로 관리합니다.</p>

<p>COW는 다음 방식으로 작동합니다.</p>

<ol>
  <li>먼저 메모리의 특정 페이지를 읽기 전용으로 표시합니다.</li>
  <li>읽기 전용 페이지에 대한 변경 요청이 들어오면 커널이 새로운 물리 공간을 할당합니다. 만일 해당 페이지에 대한 참조 개수가 하나뿐이라면 새로운 할당 없이 기존 페이지에 직접 데이터를 변경합니다.</li>
  <li>페이지 테이블의 참조를 업데이트하고 변경할 데이터를 입력합니다.</li>
</ol>

<p>이런 방식으로 원본 데이터를 보호하면서 이루어진 변경이 다른 프로세스에는 영향이 가지 않도록 할 수 있습니다.</p>

<p>COW는 보통 fork() 시스템 호출 작업을 수행하면서 많이 발생합니다.</p>

<p><img src="/img/posts/os-cow-process-fork.png" style="max-width:480px" /></p>

<p>기본적으로 fork() 시스템 호출로 자식 프로세스를 생성하면 부모 프로세스의 메모리가 그대로 복제됩니다.
이때 각 프로세스는 독립된 가상 주소 공간을 가지지만 동일한 물리 메모리를 바라보게 됩니다.</p>

<p><img src="/img/posts/os-cow-process-cow.png" style="max-width:480px" /></p>

<p>이때 부모 프로세스의 모든 메모리를 복제하게 된다면 비효율적이기 때문에 COW 메커니즘을 통해 데이터가 수정되는 경우에만 완전한 복제를 수행합니다.</p>

<p>Copy-on-Write는 프로세스 생성 초기에 메모리 복사와 관련된 오버헤드를 줄여줌으로써 성능을 향상할 수 있습니다.
특히 메모리 자원을 공유하는 프로세스가 많을수록 더 효율적입니다.
다만 메모리의 수정이 자주 발생하는 경우엔 이러한 이점이 감소할 수 있으며, 특히 메모리 페이지에 대한 복사본이 필요한 순간까지 메모리를 공유하고 있어야 하므로 추가적인 메모리 사용이 발생할 수 있습니다.</p>

<hr />

<p>References</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Virtual_memory">Virtual memory - Wikipedia</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Copy-on-write">Copy-on-write - Wikipedia</a></li>
  <li><a href="https://www.cs.uic.edu/%7Ejbell/CourseNotes/OperatingSystems/9_VirtualMemory.html">Operating Systems: Virtual Memory</a></li>
  <li><a href="https://taepcsiandwe.tistory.com/entry/%ED%8E%98%EC%9D%B4%EC%A7%80-%ED%85%8C%EC%9D%B4%EB%B8%94">페이지 테이블 :: 과학을 이해하는 개발자</a></li>
  <li><a href="https://talkingaboutme.tistory.com/entry/Study-Copy-On-Write-COW">[Study] Copy On Write (COW)</a></li>
  <li><a href="https://blog.naver.com/sqlmvp/140192006270">가상 메모리 쓰기 시 복사 (copy-on-write) : 네이버블로그</a></li>
</ul>


      <hr>

      <div id="disqus_thread"></div>
      <script>
          (function() {
          var d = document, s = d.createElement('script');
          s.src = 'https://miintto-github-io.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <hr>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="footer-content container">
    <p class="copyright text-muted">Copyright &copy; miintto 2024</p>
  </div>
</footer>


  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
<script src="/assets/scripts.js"></script>


  <script src="/assets/vendor/miintto/js/toc.js"></script>



  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXXX-X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-XXXXXXXXX-X');
</script>



</body>

</html>
