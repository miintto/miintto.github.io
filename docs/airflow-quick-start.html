<!DOCTYPE html>

<html>





<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Airflow 실행해보기 - miintto.log</title>

  <meta name="description" content="저번 포스트에서 간단히 Airflow의 구조에 대해 살펴보았다면 이번에는 Airflow를 직접 실행해 봅시다.">

  <meta name="google-site-verification" content="wGN_mZVjgAC8sdItYCBTkSMwLrgNSWPY6sicU3MuSQw" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital@1&display=swap">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://miintto.github.io/docs/airflow-quick-start">
  <link rel="alternate" type="application/rss+xml" title="Airflow 실행해보기 - miintto.log" href="/feed.xml">

  <link rel="apple-touch-icon" href="/img/favicon-128.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  <meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="blog"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="Airflow 실행해보기 - miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="저번 포스트에서 간단히 Airflow의 구조에 대해 살펴보았다면 이번에는 Airflow를 직접 실행해 봅시다."/>
  <meta prefix="og: http://ogp.me/ns#" property="og:locale" content="ko_KR"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://miintto.github.io/docs/airflow-quick-start"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/img/thumbnails/airflow.png">

</head>


<body>

  <!-- Navigation -->

<nav class="navbar" style="background-color: white;">

  <div class="navbar-content container">
    <a class="navbar-brand" href="/">miintto.log</a>
    <button class="navbar-button" id="toggleButton" type="button" data-toggle="collapse" aria-controls="navbarResponsive" aria-expanded="false">
      MENU
      <i class="fa fa-bars"></i>
    </button>
    <div class="navbar-nav" id="navbarResponsive" aria-hidden="true">
      <div class="nav-item">
        <a class="nav-link" href="/about">ABOUT</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/posts">POSTS</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/archive">ARCHIVES</a>
      </div>
    </div>
  </div>
</nav>


  <div class="article">
  <div class="article-wrapper">
    <div class="article-header">
      <div class="article-info">
        <h1>Airflow 실행해보기</h1>
        <div class="post-tags">
          <p>airflow</p><p>configuration</p>
        </div>
        <div class="article-meta">
          2023.08.29 &middot; <span class="reading-time" title="Estimated read time">
  
   8 mins  read </span>

        </div>
      </div>
      <div class="article-banner"">
        <img src="/img/thumbnails/airflow.png">
      </div>
    </div>

    <div class="article-content">
      <aside>
  <div class="section-toc">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#1-installation">1. Installation</a></li>
<li class="toc-entry toc-h1"><a href="#2-configuration">2. Configuration</a>
<ul>
<li class="toc-entry toc-h3"><a href="#core">[core]</a></li>
<li class="toc-entry toc-h3"><a href="#database">[database]</a></li>
<li class="toc-entry toc-h3"><a href="#webserver">[webserver]</a></li>
<li class="toc-entry toc-h3"><a href="#scheduler">[scheduler]</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#3-initialize-database">3. Initialize Database</a></li>
<li class="toc-entry toc-h1"><a href="#4-scheduler">4. Scheduler</a></li>
<li class="toc-entry toc-h1"><a href="#5-webserver">5. Webserver</a></li>
</ul>
  </div>
</aside>


      <p><a href="/docs/python-airflow-architecture">저번 포스트</a>에서 간단히 Airflow의 구조에 대해 살펴보았다면 이번에는 Airflow를 직접 실행해 봅시다.</p>

<p>아래에 설명된 내용들은 다음 환경 기준으로 작성되었습니다.</p>

<ul>
  <li>Python 3.11</li>
  <li>Apache Airflow 2.6.3</li>
  <li>PostgreSQL 12.14</li>
</ul>

<hr />

<h1 id="1-installation">1. Installation</h1>

<p>Airflow는 실행 시 홈 디렉토리가 정의되어 있어야 합니다.
환경변수 <strong><code class="language-plaintext highlighter-rouge">AIRFLOW_HOME</code></strong>으로 프로젝트의 홈 디렉토리를 정의할 수 있습니다.
해당 값이 설정되지 않으면 <code class="language-plaintext highlighter-rouge">~/airflow</code> 경로를 디폴트로 잡아 루트 경로에 새 프로젝트가 생성될 수 있으니 빼먹지 않도록 주의합니다.</p>

<p>현재 위치 기준으로 airflow/ 경로를 홈 디렉토리로 설정하였습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">export </span><span class="nv">AIRFLOW_HOME</span><span class="o">=</span>./airflow
</code></pre></div></div>
<p>pip를 이용해서 Airflow를 설치합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> pip <span class="nb">install </span>apache-airflow
<span class="nv">$&gt;</span> airflow version
2.6.3
</code></pre></div></div>

<p>아래와 같이 <code class="language-plaintext highlighter-rouge">AIRFLOW_HOME</code> 경로에 프로젝트가 생성되었습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> tree
<span class="nb">.</span>
└── airflow
    ├── airflow.cfg            <span class="c"># Airflow Config 파일</span>
    ├── logs/                  <span class="c"># 로그 디렉토리</span>
    └── webserver_config.py    <span class="c"># 웹서버 Config 파일</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">airflow.cfg</code> 파일은 아래서 설명할 Airflow 설정 파일입니다.
logs 디렉토리 하위에는 스케줄러 및 워커의 로그가 기록됩니다.
<code class="language-plaintext highlighter-rouge">webserver_config.py</code> 파일은 Airflow 웹서버 설정 파일입니다.</p>

<hr />

<h1 id="2-configuration">2. Configuration</h1>

<p>Airflow를 구성하는 환경 설정값들은 <strong><code class="language-plaintext highlighter-rouge">airflow.cfg</code></strong> 파일에서 관리합니다.
필요한 경우 해당 설정 파일의 변수들을 입맛에 맞게 조정할 수 있습니다.
해당 설정 파일은 Airflow 실행 시에 반드시 <code class="language-plaintext highlighter-rouge">AIRFLOW_HOME</code> 디렉토리에 위치하고 있어야 인식할 수 있습니다.</p>

<p>아래에 주로 많이 사용하는 값들을 나열해 보았는데, 더 자세한 내용을 보고 싶으면 <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html">공식 문서 링크</a>를 참고 부탁드립니다.</p>

<h3 id="core">[core]</h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">dags_folder</code></strong>: DAG파일이 존재하는 디렉토리.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">default_timezone</code></strong>: 기본 타임존.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">executor</code></strong>: 스케줄러에서 사용할 executor 클래스. (<a href="/docs/python-airflow-architecture#3-executor">이전 포스트의 Executor 설명 참조</a>)</li>
  <li><strong><code class="language-plaintext highlighter-rouge">parallelism</code></strong>: 동시에 실행 가능한 최대 Task 개수</li>
  <li><strong><code class="language-plaintext highlighter-rouge">max_active_tasks_per_dag</code></strong>: 각 DAG 마다 동시에 실행될 수 있는 task의 최대 개수</li>
  <li><strong><code class="language-plaintext highlighter-rouge">max_active_runs_per_dag</code></strong>: 동시에 실행될 수 있는 DAG의 최대 개수</li>
  <li><strong><code class="language-plaintext highlighter-rouge">load_examples</code></strong>: 예제 DAG 파을을 불러오는 여부. 큰 이슈가 없다면 <code class="language-plaintext highlighter-rouge">False</code>로 설정합니다.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">plugins_folder</code></strong>: 플러그인 폴더 경로</li>
</ul>

<h3 id="database">[database]</h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">sql_alchemy_conn</code></strong>: 메타 데이터베이스 커넥션 정보</li>
</ul>

<h3 id="webserver">[webserver]</h3>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">secret_key</code></strong>: Flask 어플리케이션에서 사용할 secert 키</li>
  <li><strong><code class="language-plaintext highlighter-rouge">workers</code></strong>: 어플리케이션을 구동시킬 gunicorn 워커 개수</li>
</ul>

<h3 id="scheduler">[scheduler]</h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">scheduler_idle_sleep_time</code></strong>: 스케줄러 루프를 한번 수행하고 다음 작업을 위해 대기하는 시간</li>
  <li><strong><code class="language-plaintext highlighter-rouge">min_file_process_interval</code></strong>: DAG 파일을 파싱하기 위해 큐에 넣는 최소 주기(초). 기본적으로 30초로 되어있으나 더 짧게 설정할수록 자주 파싱을 수행하게 되어 CPU 자원을 많이 소모합니다.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">dag_dir_list_interval</code></strong>: DAG 디렉토리를 스캔하여 리스트를 갱신하는 주기</li>
  <li><strong><code class="language-plaintext highlighter-rouge">parsing_processes</code></strong>: DAG 파일을 파싱할 때 동시에 spawn 되는 DagFileProcessor 프로세스의 최대 개수</li>
</ul>

<p>위의 내용을 바탕으로 프로젝트의 일부분을 수정하였습니다.</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">core</span>]
<span class="n">load_examples</span> = <span class="n">False</span>
<span class="n">default_timezone</span> = <span class="n">Asia</span>/<span class="n">Seoul</span>
<span class="n">executor</span> = <span class="n">LocalExecutor</span>
<span class="n">parallelism</span> = <span class="m">3</span>

[<span class="n">database</span>]
<span class="n">sql_alchemy_conn</span> = <span class="n">postgresql</span>+<span class="n">psycopg2</span>://&lt;<span class="n">user</span>&gt;:&lt;<span class="n">password</span>&gt;@&lt;<span class="n">host</span>&gt;/&lt;<span class="n">db</span>&gt;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">LocalExecutor</code>를 사용하기 위해 기본적으로 sqlite로 설정되어 있던 메타 데이터베이스를 PostgreSQL로 변경하였습니다.
<code class="language-plaintext highlighter-rouge">LocalExecutor</code>에서는 <code class="language-plaintext highlighter-rouge">parallelism</code> 값만큼 워커 프로세스를 실행하는데 최대 3개까지 실행할 수 있도록 하였습니다.
만일 0으로 설정한 경우에는 Task 실행 시마다 워커 프로세스가 spawn 됩니다.</p>

<hr />

<h1 id="3-initialize-database">3. Initialize Database</h1>

<p>PostgreSQL을 사용하기 위해 아래 라이브러리를 설치힙니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> pip <span class="nb">install </span>psycopg2
</code></pre></div></div>

<p>아래 명령어를 실행하여 메타 데이터베이스를 초기화합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow db init
</code></pre></div></div>

<p>초기 실행시 여러 테이블이 생성되는데 주요 테이블은 아래와 같습니다.</p>

<p><img src="/img/posts/airflow-quick-start-database-erd.png" style="max-width:400px" /></p>

<ul>
  <li><strong>dag</strong>: DAG 메타 정보</li>
  <li><strong>serialized_dag</strong>: DAG 및 Task 정보를 JSON 형식으로 파싱한 데이터</li>
  <li><strong>dag_code</strong>: DAG 파이썬 소스코드 전문</li>
  <li><strong>dag_run</strong>: DAG run 실행 이력</li>
  <li><strong>task_instance</strong>: Task instance 실행 이력</li>
  <li><strong>xcom</strong>: 작업 실행시 Task instance 간에 전달할 데이터</li>
  <li><strong>ab_user</strong>: 사용자 정보 테이블</li>
  <li><strong>variable</strong>: 작업시 필요한 변수들을 key-value 형식으로 저장한 데이터</li>
  <li><strong>connection</strong>: 데이터베이스 연결 정보</li>
  <li><strong>log</strong>: CLI 혹은 인터페이스에서 실행되는 이벤트 기록</li>
</ul>

<hr />

<h1 id="4-scheduler">4. Scheduler</h1>

<p>아래 명령어를 이용하여 scheduler를 실행할 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow scheduler
</code></pre></div></div>

<p>아래와 같은 테스트 DAG를 작성합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="n">airflow.operators.bash</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="kn">from</span> <span class="n">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">import</span> <span class="n">pendulum</span>

<span class="n">DAG_ID</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sample_dag</span><span class="sh">"</span>

<span class="k">with</span> <span class="nc">DAG</span><span class="p">(</span>
    <span class="n">dag_id</span><span class="o">=</span><span class="n">DAG_ID</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">샘플 코드</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="sh">"</span><span class="s">0 0 * * *</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pendulum</span><span class="p">.</span><span class="nf">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="sh">"</span><span class="s">Asia/Seoul</span><span class="sh">"</span><span class="p">),</span>
    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">echo</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Running Airflow~</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">first_task</span> <span class="o">=</span> <span class="nc">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DAG_ID</span><span class="si">}</span><span class="s">__first</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="sh">"</span><span class="s">echo start!</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">second_task</span> <span class="o">=</span> <span class="nc">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DAG_ID</span><span class="si">}</span><span class="s">__second</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">echo</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">finalize_task</span> <span class="o">=</span> <span class="nc">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DAG_ID</span><span class="si">}</span><span class="s">__finalize</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="sh">"</span><span class="s">echo finish!</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">first_task</span> <span class="o">&gt;&gt;</span> <span class="n">second_task</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">task_i</span> <span class="o">=</span> <span class="nc">BashOperator</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">DAG_ID</span><span class="si">}</span><span class="s">__task_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">bash_command</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">echo </span><span class="sh">'</span><span class="s">running task </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span><span class="s"> &amp;&amp; sleep 1</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">second_task</span> <span class="o">&gt;&gt;</span> <span class="n">task_i</span> <span class="o">&gt;&gt;</span> <span class="n">finalize_task</span>
</code></pre></div></div>

<p>여러 operator 클래스를 이용하여 Task를 정의할 수 있으며, Task간에 <code class="language-plaintext highlighter-rouge">&gt;&gt;</code> 연산자 혹은 <code class="language-plaintext highlighter-rouge">set_downstream()</code> 메소드를 이용하여 연결할 수 있습니다.</p>

<p>DAG 파일 작성 후 스케줄러가 돌아서 적당한 시간이 되면 해당 파일이 파싱 되어 메타 데이터베이스에 저장됩니다.
아래 명령어로 현재 등록된 DAG 리스트를 확인해 볼 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow dags list

dag_id     | filepath                              | owner   | paused
<span class="o">===========</span>+<span class="o">=======================================</span>+<span class="o">=========</span>+<span class="o">=======</span>
sample_dag | /your/airflow/home/dags/sample_dag.py | airflow | True 
</code></pre></div></div>

<p>아래 명령어를 입력하여 작성한 DAG를 실행해 볼 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow dags <span class="nb">test </span>sample_dag
</code></pre></div></div>

<hr />

<h1 id="5-webserver">5. Webserver</h1>

<p>아래 명령어를 입력하여 사용자를 생성할 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow <span class="nb">users </span>create <span class="se">\</span>
    <span class="nt">--username</span> miintto <span class="se">\</span>
    <span class="nt">--firstname</span> Park <span class="se">\</span>
    <span class="nt">--lastname</span> Minjae <span class="se">\</span>
    <span class="nt">--role</span> Admin <span class="se">\</span>
    <span class="nt">--email</span> admin@miintto.com
Password:
</code></pre></div></div>

<p>입력한 패스워드는 웹서버 접속 시 필요하므로 꼭 기억해 두도록 합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> airflow webserver
</code></pre></div></div>

<p>웹서버는 기본적으로 8080 포트로 실행됩니다.
<u>http://localhost:8080</u> 경로로 웹서버에 접속할 수 있습니다.</p>

<p><img src="/img/posts/airflow-quick-start-webserver-login.png" style="max-width:640px" /></p>

<p>사용자 생성시 입력했던 username과 비밀번호를 입력하여 로그인힙니다.</p>

<p><img src="/img/posts/airflow-quick-start-webserver-dashboard.png" style="max-width:640px" /></p>

<p>메인 대시보드 화면에서 작성했던 DAG 리스트 및 Task 실행 현황을 모니터링 할 수 있습니다.</p>

<hr />

<p>References</p>

<ul>
  <li>Bas Harenslak &amp; Julian de Ruiter, 『Data Pipeline with Apache Airflow』, 김정민 &amp; 문선홍, 제이펍, 2022-03-16</li>
  <li><a href="https://airflow.apache.org/docs/apache-airflow/stable/start.html">Quick Start — Airflow Documentation</a></li>
</ul>


      <hr>

      <div id="disqus_thread"></div>
      <script>
          (function() {
          var d = document, s = d.createElement('script');
          s.src = 'https://miintto-github-io.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <hr>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="footer-content container">
    <p class="copyright text-muted">Copyright &copy; miintto 2024</p>
  </div>
</footer>


  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
<script src="/assets/scripts.js"></script>


  <script src="/assets/vendor/miintto/js/toc.js"></script>



  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXXX-X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-XXXXXXXXX-X');
</script>



</body>

</html>
