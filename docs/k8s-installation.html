<!DOCTYPE html>

<html>





<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>[쿠버네티스] 무작정 설치해보기 - miintto.log</title>

  <meta name="description" content="쿠버네티스는 컨테이너화된 애플리케이션을 자동으로 배포, 스케일링 및 관리해주는 오픈소스입니다. 이제는 백엔드를 한다면 빗겨갈수 없는 기술이 되어버린 터라 공부의 필요성은 계속 느껴왔는데요. 내일 공부해야지 하고 차일 피일 미루다 영영 기약이 없을것 같아서… 어디다가 설치라도 해보면...">

  <meta name="google-site-verification" content="wGN_mZVjgAC8sdItYCBTkSMwLrgNSWPY6sicU3MuSQw" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital@1&display=swap">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://miintto.github.io/docs/k8s-installation">
  <link rel="alternate" type="application/rss+xml" title="[쿠버네티스] 무작정 설치해보기 - miintto.log" href="/feed.xml">

  <link rel="apple-touch-icon" href="/img/favicon-128.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  <meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="blog"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="[쿠버네티스] 무작정 설치해보기 - miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="쿠버네티스는 컨테이너화된 애플리케이션을 자동으로 배포, 스케일링 및 관리해주는 오픈소스입니다. 이제는 백엔드를 한다면 빗겨갈수 없는 기술이 되어버린 터라 공부의 필요성은 계속 느껴왔는데요. 내일 공부해야지 하고 차일 피일 미루다 영영 기약이 없을것 같아서… 어디다가 설치라도 해보면..."/>
  <meta prefix="og: http://ogp.me/ns#" property="og:locale" content="ko_KR"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://miintto.github.io/docs/k8s-installation"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/img/thumbnails/k8s.png">

</head>


<body>

  <!-- Navigation -->

<nav class="navbar" style="background-color: white;">

  <div class="navbar-content container">
    <a class="navbar-brand" href="/">miintto.log</a>
    <button class="navbar-button" id="toggleButton" type="button" data-toggle="collapse" aria-controls="navbarResponsive" aria-expanded="false">
      MENU
      <i class="fa fa-bars"></i>
    </button>
    <div class="navbar-nav" id="navbarResponsive" aria-hidden="true">
      <div class="nav-item">
        <a class="nav-link" href="/about">ABOUT</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/posts">POSTS</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/archive">ARCHIVES</a>
      </div>
    </div>
  </div>
</nav>


  <div class="article">
  <div class="article-wrapper">
    <div class="article-header">
      <div class="article-info">
        <h1>[쿠버네티스] 무작정 설치해보기</h1>
        <div class="post-tags">
          <p>k8s</p><p>aws</p><p>cluster</p>
        </div>
        <div class="article-meta">
          2022.05.05 &middot; <span class="reading-time" title="Estimated read time">
  
   8 mins  read </span>

        </div>
      </div>
      <div class="article-banner"">
        <img src="/img/thumbnails/k8s.png">
      </div>
    </div>

    <div class="article-content">
      <aside>
  <div class="section-toc">
  </div>
</aside>


      <p>쿠버네티스는 컨테이너화된 애플리케이션을 자동으로 배포, 스케일링 및 관리해주는 오픈소스입니다.
이제는 백엔드를 한다면 빗겨갈수 없는 기술이 되어버린 터라 공부의 필요성은 계속 느껴왔는데요.
내일 공부해야지 하고 차일 피일 미루다 영영 기약이 없을것 같아서…
어디다가 설치라도 해보면 그래도 조금은 들여다 보겠지 싶어 무작정 설치부터 해보았습니다.</p>

<hr />

<h1 id="1-사전-작업">1. 사전 작업</h1>

<h2 id="11-인스턴스">1.1 인스턴스</h2>

<p>쿠버네티스를 제대로 활용하기 위해서는 최소 3개 이상의 인스턴스가 필요합니다.
또한 각 인스턴스는 2GB 이상의 메모리 2 CPU 이상의 자원이 필요합니다.
해당 리소스보다 부족한 경우 애플리케이션이 제대로 가동되지 않을 수 있습니다.
이번 과정에서는 마스터 노드 1개, 워커 노드 2개로 구성하였고 자세한 구성 환경은 다음과 같습니다.</p>

<ul>
  <li>OS: Amazon Linux 2
    <ul>
      <li>4GB RAM / 2 vCPU</li>
    </ul>
  </li>
  <li>Kubernetes: v1.24.0</li>
  <li>Runtime: Docker v20.10.7</li>
</ul>

<h2 id="12-서버-시간-동기화">1.2 서버 시간 동기화</h2>

<p>각 인스턴스는 서버의 시간이 동기화 되어있어야합니다.
일반적으로 ntp를 사용하지만 Amazon Linux 2 에서는 기본적으로 <strong>chrony</strong> 라는 인터페이스가 설치되어 있으므로 ntp 대신 활용하였습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> vim /etc/chrony.conf
<span class="c"># 아래 내용 체크</span>
server 169.254.169.123 prefer iburst minpoll 4 maxpoll 4

<span class="nv">$&gt;</span> chronyc tracking  <span class="c"># 지표 확인</span>
Reference ID    : A9FEA97B <span class="o">(</span>169.254.169.123<span class="o">)</span>
Stratum         : 4
Ref <span class="nb">time</span> <span class="o">(</span>UTC<span class="o">)</span>  : Thu May 05 04:58:48 2022
System <span class="nb">time</span>     : 0.000001882 seconds slow of NTP <span class="nb">time
</span>Last offset     : <span class="nt">-0</span>.000000258 seconds
...

<span class="nv">$&gt;</span> <span class="nb">sudo cp</span> <span class="nt">-av</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime  <span class="c"># KST로 변경</span>
<span class="nv">$&gt;</span> <span class="nb">date
</span>2022. 05. 05. <span class="o">(</span>목<span class="o">)</span> 14:01:46 KST
</code></pre></div></div>

<h2 id="13-고유한-mac-주소-확인">1.3 고유한 MAC 주소 확인</h2>

<p>클러스터를 구성하는 노드들은 서로간에 고유한 MAC 주소 및 product_uuid를 가지고 있어야 합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 주소 비교</span>
<span class="nv">$&gt;</span> ifconfig | egrep <span class="s2">"^</span><span class="se">\\</span><span class="s2">w|ether"</span>

<span class="c"># product_uuid 비교</span>
<span class="nv">$&gt;</span> <span class="nb">sudo cat</span> /sys/class/dmi/id/product_uuid
</code></pre></div></div>

<h2 id="14-스왑-메모리-해제">1.4 스왑 메모리 해제</h2>

<p>메모리 스왑이 활성되어 있으면 컨테이너의 성능이 일관되지 않을 수 있으므로 비활성화 해줍니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> swapoff <span class="nt">-a</span>
</code></pre></div></div>

<h2 id="15-특정-포트-개방">1.5 특정 포트 개방</h2>

<p>6443번 포트는 마스터 노드의 API 서버가 노드간 통신을 위해 사용하는 포트입니다.
해당 포트가 개방되어있는지 체크합니다.
저는 AWS 인스턴스를 사용하여 해당 인터페이스에서 조정하였습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> telnet 127.0.0.1 6443
</code></pre></div></div>

<h2 id="16-런타임-설치">1.6 런타임 설치</h2>

<p>노드에서 Pod를 실행할 수 있도록 각 노드마다 컨테이너 런타임이 필요합니다.
쿠버네티스는 Docker, Containerd, Cri-O 등의 런타임을 지원하지만 가장 보편적으로 사용하는 Docker를 설치하겠습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">sudo </span>yum update <span class="nt">-y</span>
<span class="nv">$&gt;</span> <span class="nb">sudo </span>amazon-linux-extras <span class="nb">install</span> <span class="nt">-y</span> docker
<span class="nv">$&gt;</span> <span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker.service
<span class="nv">$&gt;</span> <span class="nb">sudo </span>systemctl start docker.service
</code></pre></div></div>

<p>Cgroup은 컨테이너에 할당된 리소스를 관리하는 기능입니다.
기본적으로 <code class="language-plaintext highlighter-rouge">cgroupfs</code> 으로 되어있지만 <code class="language-plaintext highlighter-rouge">systemd</code>로 변경하는것을 권장합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> docker info | <span class="nb">grep </span>Cgroup
 Cgroup Driver: cgroupfs
 Cgroup Version: 1

<span class="nv">$&gt;</span> vim /lib/systemd/system/docker.service
<span class="c"># native.cgroupdriver=systemd 로 변경</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd <span class="nt">-H</span> fd:// <span class="nt">--containerd</span><span class="o">=</span>/run/containerd/containerd.sock <span class="nt">--exec-opt</span> native.cgroupdriver<span class="o">=</span>systemd

<span class="nv">$&gt;</span> <span class="nb">sudo </span>systemctl daemon-reload
<span class="nv">$&gt;</span> <span class="nb">sudo </span>systemctl restart docker.service

<span class="nv">$&gt;</span> docker info | <span class="nb">grep </span>Cgroup
 Cgroup Driver: systemd
 Cgroup Version: 1
</code></pre></div></div>

<blockquote>
  <p>❗️ 나중에 설치하고서야 알게된 사실인데, 쿠버네티스가 1.20 버전부터는 런타임으로 도커 엔진을 지원하지 않는다고 합니다ㅠㅠ 다행히 도커를 설치하면서 곁다리로 containerd가 딸려와서 대신 활용하도록 하겠습니다.</p>
</blockquote>

<hr />

<h1 id="2-쿠버네티스-설치">2. 쿠버네티스 설치</h1>

<p>쿠버네티스를 설치하는 과정은 kubeadm, kops등 여러 방법으로 가능하지만, 가장 보편적인 kubeadm를 이용한 방법으로 진행하겠습니다.</p>

<h2 id="21-kubeadm-설치">2.1 kubeadm 설치</h2>

<p>먼저 kubeadm을 가져오기 위해 repo를 등록합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-</span><span class="se">\$</span><span class="sh">basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Selinux 설정을 해제합니다.
가이드에는 컨테이너가 파일 시스템에 접근이 가능하도록 허용하기 위함이라고 하는데 kubelet 설치 과정에서 일부 권한의 제약이 있는 듯 합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">sudo </span>setenforce 0
<span class="nv">$&gt;</span> <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/^SELINUX=enforcing$/SELINUX=permissive/'</span> /etc/selinux/config
</code></pre></div></div>

<p>kubelet, kubeadm, kubectl 를 설치합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
<span class="nv">$&gt;</span> <span class="nb">sudo </span>systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
<span class="nv">$&gt;</span> kubeadm version
kubeadm version: &amp;version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"24"</span>, GitVersion:<span class="s2">"v1.24.0"</span>, ...
</code></pre></div></div>

<p>kubeadm 설치 중 다음과 같은 에러가 나는 경우가 있는데</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>repomd.xml signature could not be verified <span class="k">for </span>kubernetes
</code></pre></div></div>

<p>정식 해결 방법은 아니지만 <code class="language-plaintext highlighter-rouge">repo_gpgcheck=0</code> 으로 해제 후 다시 설치를 이어갑니다.</p>

<h2 id="22-클러스터-구성">2.2 클러스터 구성</h2>

<p>마스터 노드로 사용할 인스턴스에 먼저 클러스터를 초기화 합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">sudo </span>kubeadm init

...
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
  <span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  <span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config

Alternatively, <span class="k">if </span>you are the root user, you can run:

  <span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="s2">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="nb">join </span>any number of worker nodes by running the following on each as root:

kubeadm <span class="nb">join </span>172.xx.xx.180:6443 <span class="nt">--token</span> o2eccn... <span class="se">\</span>
	<span class="nt">--discovery-token-ca-cert-hash</span> sha256:8e72e...
</code></pre></div></div>

<p>실행이 완료되면 여러 설명이 나오는데 초기 구성시 실행해야할 명령어 및 애드온 추가 방법에 대한 내용입니다.
마지막에 나온 토큰값은 워커 노드가 마스터로 합류할 때 필요하니 기억해두도록 합니다.
설치시 root 권한으로 진행했기 때문에 다음 명령어를 입력합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> <span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</code></pre></div></div>

<h2 id="23-네트워크-애드온-설치">2.3 네트워크 애드온 설치</h2>

<p>컨테이너간 원할한 네트워크 통신을 위해 calico를 설치합니다.
작성하는 시점 기준으로는 v3.22가 가장 최신이라 해당 버전으로 설치하였습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> kubectl apply <span class="nt">-f</span> https://docs.projectcalico.org/v3.22/manifests/calico.yaml
<span class="nv">$&gt;</span> kubectl get pods <span class="nt">--namespace</span> kube-system
NAME                              READY   STATUS    RESTARTS   AGE
calico-kube-controllers-7748...   1/1     Running   0          50s
calico-node-bxfj2                 1/1     Running   0          50s
...
</code></pre></div></div>

<p>컴포넌트를 조회하여 모두 <code class="language-plaintext highlighter-rouge">Running</code> 상태이면 정상적으로 설치가 완료된 상태입니다.</p>

<h2 id="24-워커-노드-합류">2.4 워커 노드 합류</h2>

<p>마스터 노드의 토큰값을 이용하여 각 워커 노드에서 다음을 실행하여 마스터 노드로 합류합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$&gt;</span> kubeadm <span class="nb">join </span>172.xx.xx.180:6443 <span class="nt">--token</span> o2eccn... <span class="se">\</span>
	<span class="nt">--discovery-token-ca-cert-hash</span> sha256:8e72e...

...
This node has joined the cluster:
<span class="k">*</span> Certificate signing request was sent to apiserver and a response was received.
<span class="k">*</span> The Kubelet was informed of the new secure connection details.

Run <span class="s1">'kubectl get nodes'</span> on the control-plane to see this node <span class="nb">join </span>the cluster.
</code></pre></div></div>

<p>만일 토큰이 기억나지 않거나 만료되었다면 다시 조회할 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> kubeadm token list
TOKEN       TTL         EXPIRES                USAGES                  ...
o2eccn...   40m         2022-05-08T06:48:42Z   authentication,signing  ...

<span class="nv">$&gt;</span> openssl x509 <span class="nt">-pubkey</span> <span class="nt">-in</span> /etc/kubernetes/pki/ca.crt | openssl rsa <span class="nt">-pubin</span> <span class="nt">-outform</span> der 2&gt;/dev/null | openssl dgst <span class="nt">-sha256</span> <span class="nt">-hex</span>
<span class="o">(</span>stdin<span class="o">)=</span> 8e72e...
</code></pre></div></div>

<p>노드의 상태를 조회하여 정상적으로 클러스터가 구성되었는지 확인합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$&gt;</span> kubectl get nodes
NAME                               STATUS   ROLES           AGE     VERSION
ip-172-xx-xx-180.ap-northeast...   Ready    control-plane   7m9s    v1.24.0
ip-172-xx-xx-73.ap-northeast...    Ready    &lt;none&gt;          10s     v1.24.0
ip-172-xx-xx-221.ap-northeast...   Ready    &lt;none&gt;          15s     v1.24.0
</code></pre></div></div>

<hr />

<p>References</p>

<ul>
  <li>용찬호, 시작하세요! 도커/쿠버네티스, 위키북스, 2020-01-03</li>
  <li><a href="https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">kubeadm 설치하기</a></li>
  <li><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/set-time.html">Linux 인스턴스의 시간 설정</a></li>
  <li><a href="https://kubernetes.io/ko/docs/setup/production-environment/container-runtimes/">컨테이너 런타임</a></li>
  <li><a href="https://kubernetes.io/ko/docs/setup/production-environment/tools/_print/">배포 도구로 쿠버네티스 설치하기</a></li>
</ul>


      <hr>

      <div id="disqus_thread"></div>
      <script>
          (function() {
          var d = document, s = d.createElement('script');
          s.src = 'https://miintto-github-io.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <hr>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="footer-content container">
    <p class="copyright text-muted">Copyright &copy; miintto 2024</p>
  </div>
</footer>


  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
<script src="/assets/scripts.js"></script>


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXXX-X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-XXXXXXXXX-X');
</script>



</body>

</html>
