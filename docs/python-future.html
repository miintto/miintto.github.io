<!DOCTYPE html>

<html>





<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>[파이썬] Future를 이용한 동시성 - miintto.log</title>

  <meta name="description" content="1. Future">

  <meta name="google-site-verification" content="wGN_mZVjgAC8sdItYCBTkSMwLrgNSWPY6sicU3MuSQw" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital@1&display=swap">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://miintto.github.io/docs/python-future">
  <link rel="alternate" type="application/rss+xml" title="[파이썬] Future를 이용한 동시성 - miintto.log" href="/feed.xml">

  <link rel="apple-touch-icon" href="/img/favicon-128.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  <meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="blog"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="[파이썬] Future를 이용한 동시성 - miintto.log"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="1. Future"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:locale" content="ko_KR"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://miintto.github.io/docs/python-future"/>
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/img/thumbnails/python.png">

</head>


<body>

  <!-- Navigation -->

<nav class="navbar" style="background-color: white;">

  <div class="navbar-content container">
    <a class="navbar-brand" href="/">miintto.log</a>
    <button class="navbar-button" id="toggleButton" type="button" data-toggle="collapse" aria-controls="navbarResponsive" aria-expanded="false">
      MENU
      <i class="fa fa-bars"></i>
    </button>
    <div class="navbar-nav" id="navbarResponsive" aria-hidden="true">
      <div class="nav-item">
        <a class="nav-link" href="/about">ABOUT</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/posts">POSTS</a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="/archive">ARCHIVES</a>
      </div>
    </div>
  </div>
</nav>


  <div class="article">
  <div class="article-wrapper">
    <div class="article-header">
      <div class="article-info">
        <h1>[파이썬] Future를 이용한 동시성</h1>
        <div class="post-tags">
          <p>python</p><p>future</p><p>multi-threading</p>
        </div>
        <div class="article-meta">
          2022.10.05 &middot; <span class="reading-time" title="Estimated read time">
  
   7 mins  read </span>

        </div>
      </div>
      <div class="article-banner"">
        <img src="/img/thumbnails/python.png">
      </div>
    </div>

    <div class="article-content">
      <aside>
  <div class="section-toc">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#1-future">1. Future</a>
<ul>
<li class="toc-entry toc-h2"><a href="#11-concurrentfuture">1.1 concurrent.future</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#2-multi-threading">2. Multi Threading</a>
<ul>
<li class="toc-entry toc-h2"><a href="#21-multi-processing">2.1 Multi Processing</a></li>
</ul>
</li>
</ul>
  </div>
</aside>


      <h1 id="1-future">1. Future</h1>

<p><strong><code class="language-plaintext highlighter-rouge">Future</code></strong>는 비동기 작업의 상태를 나타내주는 객체로 계산이 지연된 것을 표현하기 위해 사용합니다.
특정한 작업을 큐에 넣거나 완료 상태를 조사하고, 에러 또는 결과를 반환하는 역할을 합니다.
파이썬 내장 라이브러리 <code class="language-plaintext highlighter-rouge">concurrent.futures</code> 와 <code class="language-plaintext highlighter-rouge">asyncio</code> 내부에 구현되어 있으며 핵심 기능은 같지만 살짝 다르게 동작하는 부분도 있습니다.
JavaScript 의 Promise 객체와 유사하다고 볼 수도 있습니다.</p>

<p><code class="language-plaintext highlighter-rouge">Future</code> 객체는 반드시 <code class="language-plaintext highlighter-rouge">concurrent.futures</code>, <code class="language-plaintext highlighter-rouge">asyncio</code>과 같은 동시성 라이브러리의 통제 하에 사용해야합니다.
객체의 상태를 명시해주는 인터페이스도 제공하여 필요한 경우에는 실행이 완료되었는지 여부를 확인할 수도 있습니다.
<code class="language-plaintext highlighter-rouge">Future</code> 객체에 대한 요청은 반드시 이러한 라이브러리를 이용해야 하며 해당 객체를 직접 생성하거나 변경하는 것은 지양해야합니다.
해당 라이브러리는 <code class="language-plaintext highlighter-rouge">Future</code> 객체를 생성 및 스케줄링 하며, 작업이 완료된 경우 <code class="language-plaintext highlighter-rouge">Future</code> 객체의 상태를 변경합니다.
웬만하면 우리는 직접 <code class="language-plaintext highlighter-rouge">Future</code> 객체를 마주할 일은 없고, 라이브러리 내부에서 해당 객체를 사용하여 동작하도록 되어있습니다.</p>

<h2 id="11-concurrentfuture">1.1 concurrent.future</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Future</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_condition</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Condition</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">PENDING</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_waiters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_done_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_done_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_condition</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CANCELLED</span><span class="p">,</span> <span class="n">CANCELLED_AND_NOTIFIED</span><span class="p">,</span> <span class="n">FINISHED</span><span class="p">]:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_done_callbacks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">fn</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">'</span><span class="s">exception calling callback for %r</span><span class="sh">'</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">add_done_callback</code>메소드는</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_condition</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CANCELLED</span><span class="p">,</span> <span class="n">CANCELLED_AND_NOTIFIED</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="nc">CancelledError</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">FINISHED</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">__get_result</span><span class="p">()</span>

                <span class="n">self</span><span class="p">.</span><span class="n">_condition</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CANCELLED</span><span class="p">,</span> <span class="n">CANCELLED_AND_NOTIFIED</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="nc">CancelledError</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">FINISHED</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">__get_result</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Break a reference cycle with the exception in self._exception
</span>            <span class="n">self</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<h1 id="2-multi-threading">2. Multi Threading</h1>

<p>다음은 두 가지 방법을 이용하여 웹 상의 이미지를 가져오는 코드입니다.
requests를 이용하여 요청을 보냈고, 이미지 저장 소요시간을 가정하여 1초의 sleep을 두었습니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">requests</span>

<span class="n">FLAG_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">CA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">DE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">FR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">GB</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">JP</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">KR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">US</span><span class="sh">"</span><span class="p">]</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://www.fluentpython.com</span><span class="sh">"</span>


<span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="n">flag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/data/flags/</span><span class="si">{</span><span class="n">flag</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">flag</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span><span class="si">}</span><span class="s">.gif</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">status_code</span>

<span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="n">flag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="nf">get_request</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">download1</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">이미지를 차례로 다운로드</span><span class="sh">"""</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">status_list</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="n">FLAG_LIST</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">status_list</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Count:</span><span class="sh">"</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Time:</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">download2</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">이미지를 멀티 스레드를 사용하여 다운로드</span><span class="sh">"""</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">with</span> <span class="n">futures</span><span class="p">.</span><span class="nc">ThreadPoolExecutor</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="n">FLAG_LIST</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Count:</span><span class="sh">"</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Time:</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>


<span class="nf">download1</span><span class="p">()</span>
<span class="c1"># CA DE FR IT JP KR GB US Count: 8
# Time: 9.633826971054077
</span>
<span class="nf">download2</span><span class="p">()</span>
<span class="c1"># JP FR GB US DE KR CA IT Count: 8
# Time: 1.3326849937438965
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">download1</code> 에서는 이미지를 순차적으로 가져오고 <code class="language-plaintext highlighter-rouge">download2</code> 함수에서는 ThreadPoolExecutor 를 이용하여 가져오고 있습니다.
두 번째 방법이 훨씬 시간이 적게 걸리는 것을 확인할 수 있는데, 멀티 스레드를 사용하여 동시에 여러 작업을 수행하였기 때문입니다.</p>

<p><code class="language-plaintext highlighter-rouge">Executor.map()</code> 함수는 내부에서 Future 를 이용합니다.
<code class="language-plaintext highlighter-rouge">Executor.submit()</code> 의 결과로 Future 객체들을 생성하고 해당 객체들이 담긴 제너레이터를 결과값으로 반환합니다.
제너레이터에 <code class="language-plaintext highlighter-rouge">__next__</code> 메소드가 호출될때마다 각 Future 객체의 <code class="language-plaintext highlighter-rouge">result()</code> 함수를 실행하여 그 결과값을 호출한 순서대로 반환합니다.
해당 작업이 진행되는 동안 Future 객체는 Executor 내부에서만 존재하므로 Future 객체를 직접 볼 수는 없습니다.</p>

<p>앞서 <a href="/docs/python-gil"><strong>GIL</strong></a>을 설명하면서 파이썬은 기본적으로 단일 스레드만 사용한다고 말씀드렸습니다.
하지만 <code class="language-plaintext highlighter-rouge">requests</code>, <code class="language-plaintext highlighter-rouge">sleep</code> 과 같은 입출력 작업에서는 GIL을 우회하므로 입출력을 기다리는 동안 다른 스레드로 전환할 수 있습니다.
이러한 방식을 활용하면 여러 스레드를 이용하여 효율적으로 프로그램을 실행할 수 있습니다.</p>

<h2 id="21-multi-processing">2.1 Multi Processing</h2>

<p>스레드 대신 여러 프로세스를 사용하도록 <em>ProcessPoolExecutor</em> 로 대치할 수도 있습니다.
해당 클래스를 이용하면 작업을 여러 프로세스에 분산시켜 병렬 컴퓨팅을 가능하게 합니다.
다만 단순 입출력에서는 멀티 프로세스를 사용해도 큰 성능상의 이득을 얻지 못할수도 있는데, 대신 복잡한 연산 위주의 작업이라면 멀티 프로세스를 활용하는게 파이썬에서는 더 효율적입니다.</p>

<hr />

<p>References</p>

<ul>
  <li>Luciano Ramalho, Fluent Python: Clear, Concise, and Effective Programming, 강권학, 한빛미디어, 2016-08-12</li>
  <li><a href="https://docs.python.org/ko/3/library/concurrent.futures.html">concurrent.futures - Launching parallel tasks - Python 3.10.2 documentation</a></li>
</ul>


      <hr>

      <div id="disqus_thread"></div>
      <script>
          (function() {
          var d = document, s = d.createElement('script');
          s.src = 'https://miintto-github-io.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <hr>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="footer-content container">
    <p class="copyright text-muted">Copyright &copy; miintto 2024</p>
  </div>
</footer>


  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
<script src="/assets/scripts.js"></script>


  <script src="/assets/vendor/miintto/js/toc.js"></script>



  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXXX-X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-XXXXXXXXX-X');
</script>



</body>

</html>
